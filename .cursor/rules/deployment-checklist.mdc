---
description: 배포 시 필수 체크리스트
---

# 배포 체크리스트

## 🚀 배포 전 필수 확인사항

### 1. 코드 변경사항 검토
- [ ] 모든 DB 조회에 `user_id` 필터링 확인
- [ ] 세션 소유권 검증 함수들 확인
- [ ] Edge Function 입력 검증 확인
- [ ] 환경 변수 검증 확인

### 2. 보안 검증
- [ ] `fetchUserSessions()`: `.eq('user_id', userId)` 필터링
- [ ] `fetchStatsByType()`: 조인 쿼리에서 user_id 필터링
- [ ] `fetchSessionProblems()`: 세션 소유권 검증
- [ ] `deleteSession()`: 소유권 검증 후 삭제
- [ ] `vw_stats_by_type` 뷰 사용 금지

### 3. Edge Function 검증
- [ ] 입력 파라미터 검증 (`imageBase64`, `userId` 필수)
- [ ] 환경 변수 검증 (`SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `GEMINI_API_KEY`)
- [ ] 각 단계별 로깅 확인
- [ ] 에러 핸들링 확인

## 📦 배포 프로세스

### 1. 클라이언트 코드 배포 (자동)
```bash
# Git 커밋 및 푸시
git add .
git commit -m "변경사항 설명"
git push
```
- Netlify에서 자동 배포 진행
- 배포 완료 후 URL 확인

### 2. Edge Function 배포 (수동)
```bash
# Supabase CLI로 Edge Function 배포
supabase functions deploy analyze-image
```
- Supabase 대시보드에서 버전 확인
- Edge Function 로그에서 "Step 1-5" 확인

### 3. 배포 후 검증
- [ ] 브라우저에서 앱 접속 확인
- [ ] 이미지 업로드 테스트
- [ ] 다른 사용자 계정으로 데이터 격리 테스트
- [ ] Edge Function 로그 확인

## 🔍 배포 후 필수 테스트

### 1. 기본 기능 테스트
- [ ] 이미지 업로드 → 성공 메시지 표시
- [ ] `/recent` 페이지 이동 확인
- [ ] AnalyzingCard 표시 확인
- [ ] AI 분석 완료 → QuickLabelingCard 표시
- [ ] 라벨링 완료 → "최근 업로드한 문제"에 추가

### 2. 보안 테스트 (중요!)
- [ ] **사용자 A로 로그인** → 데이터 생성
- [ ] **사용자 B로 로그인** → 사용자 A 데이터가 보이지 않는지 확인
- [ ] **통계 페이지** → 사용자 B 데이터만 표시되는지 확인
- [ ] **세션 접근** → 다른 사용자 세션에 접근 불가능한지 확인

### 3. Edge Function 테스트
- [ ] Supabase 대시보드 → Edge Function 로그 확인
- [ ] "Step 1: Upload image to storage..." 로그 확인
- [ ] "Step 2: Create session..." 로그 확인
- [ ] "Step 3: Analyzing image with Gemini..." 로그 확인
- [ ] "Step 4: Save problems..." 로그 확인
- [ ] "Step 5: Save labels..." 로그 확인

## ⚠️ 문제 발생 시 대응

### 1. 이미지 업로드 실패
- [ ] 브라우저 콘솔 로그 확인
- [ ] Supabase Edge Function 로그 확인
- [ ] 환경 변수 설정 확인
- [ ] Edge Function 재배포

### 2. 데이터 공유 문제
- [ ] 즉시 서비스 중단
- [ ] 모든 사용자 로그아웃 강제
- [ ] 코드 수정 후 재배포
- [ ] 사용자별 데이터 격리 재검증

### 3. Edge Function 실패
- [ ] Supabase 로그 확인
- [ ] 환경 변수 재확인
- [ ] Edge Function 재배포
- [ ] 단계별 로깅 확인

## 🎯 재발 방지 핵심 원칙

1. **절대 규칙**: user_id 필터링 없이는 어떤 데이터도 조회하지 말 것
2. **이중 검증**: RLS + 애플리케이션 레벨 필터링
3. **배포 검증**: 코드 변경 시 반드시 다중 사용자 테스트
4. **로깅 필수**: 모든 보안 관련 작업에 로깅 추가