---
description: ë³´ì•ˆ ê´€ë ¨ ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸
---

# ë³´ì•ˆ ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸

## ğŸš¨ CRITICAL: DB ì¡°íšŒ í•¨ìˆ˜ ê²€ì¦

### fetchUserSessions() í•¨ìˆ˜
```typescript
// âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
export async function fetchUserSessions(): Promise<SessionWithProblems[]> {
  const userId = await getCurrentUserId();
  
  const { data, error } = await supabase
    .from('sessions')
    .select(`...`)
    .eq('user_id', userId)  // â† ì´ ë¶€ë¶„ì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•¨
    .order('created_at', { ascending: false });
}

// âŒ ìœ„í—˜í•œ íŒ¨í„´
export async function fetchUserSessions(): Promise<SessionWithProblems[]> {
  // userId ê°€ì ¸ì˜¤ê¸° ìƒëµ
  const { data, error } = await supabase
    .from('sessions')
    .select(`...`)
    // .eq('user_id', userId) â† ì´ ë¶€ë¶„ì´ ì—†ìœ¼ë©´ ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° ë…¸ì¶œ!
    .order('created_at', { ascending: false });
}
```

### fetchStatsByType() í•¨ìˆ˜
```typescript
// âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
export async function fetchStatsByType(): Promise<TypeStatsRow[]> {
  const userId = await getCurrentUserId();
  
  const { data, error } = await supabase
    .from('labels')
    .select(`
      classification,
      is_correct,
      problems!inner (
        session_id,
        sessions!inner (
          user_id
        )
      )
    `)
    .eq('problems.sessions.user_id', userId);  // â† ì´ ë¶€ë¶„ì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•¨
}

// âŒ ìœ„í—˜í•œ íŒ¨í„´
export async function fetchStatsByType(): Promise<TypeStatsRow[]> {
  // userId ê°€ì ¸ì˜¤ê¸° ìƒëµ
  const { data, error } = await supabase.from('vw_stats_by_type').select('*');
  // â† vw_stats_by_type ë·°ëŠ” RLSê°€ ì—†ì–´ì„œ ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° ë…¸ì¶œ!
}
```

### ì„¸ì…˜ ì ‘ê·¼ í•¨ìˆ˜ë“¤
```typescript
// âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
export async function fetchSessionProblems(sessionId: string): Promise<ProblemItem[]> {
  const userId = await getCurrentUserId();
  
  // ì„¸ì…˜ ì†Œìœ ê¶Œ ê²€ì¦
  const { data: session, error: sessionError } = await supabase
    .from('sessions')
    .select('user_id')
    .eq('id', sessionId)
    .single();
  
  if (sessionError) throw sessionError;
  if (session.user_id !== userId) {  // â† ì´ ë¶€ë¶„ì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•¨
    throw new Error('ì´ ì„¸ì…˜ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  // ì´í›„ ì¡°íšŒ ë¡œì§...
}

// âŒ ìœ„í—˜í•œ íŒ¨í„´
export async function fetchSessionProblems(sessionId: string): Promise<ProblemItem[]> {
  // ì†Œìœ ê¶Œ ê²€ì¦ ìƒëµ
  const { data: problems, error: problemsError } = await supabase
    .from('problems')
    .select(`...`)
    .eq('session_id', sessionId);  // â† ë‹¤ë¥¸ ì‚¬ìš©ì ì„¸ì…˜ë„ ì ‘ê·¼ ê°€ëŠ¥!
}
```

## ğŸ”’ Edge Function ë³´ì•ˆ ê²€ì¦

### ì…ë ¥ ê²€ì¦ (í•„ìˆ˜)
```typescript
// âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
const { imageBase64, mimeType, userId, fileName } = await req.json();

if (!imageBase64 || !userId) {  // â† í•„ìˆ˜ ê²€ì¦
  console.log('Missing required fields');
  return new Response(JSON.stringify({ error: 'Missing required fields: imageBase64, userId' }), { 
    status: 400, 
    headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
  });
}

// âŒ ìœ„í—˜í•œ íŒ¨í„´
const { imageBase64, mimeType, userId, fileName } = await req.json();
// ê²€ì¦ ì—†ì´ ë°”ë¡œ ì‚¬ìš©í•˜ë©´ ì˜ëª»ëœ ë°ì´í„°ë¡œ ì¸í•œ ì˜¤ë¥˜ ë°œìƒ
```

### í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ (í•„ìˆ˜)
```typescript
// âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
const supabaseUrl = Deno.env.get('SUPABASE_URL');
const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
const geminiApiKey = Deno.env.get('GEMINI_API_KEY');

if (!supabaseUrl || !supabaseServiceKey) {  // â† í•„ìˆ˜ ê²€ì¦
  throw new Error('Missing Supabase environment variables');
}

if (!geminiApiKey) {  // â† í•„ìˆ˜ ê²€ì¦
  throw new Error('GEMINI_API_KEY environment variable is not set');
}

// âŒ ìœ„í—˜í•œ íŒ¨í„´
const supabaseUrl = Deno.env.get('SUPABASE_URL');
// ê²€ì¦ ì—†ì´ ë°”ë¡œ ì‚¬ìš©í•˜ë©´ í™˜ê²½ ë³€ìˆ˜ ëˆ„ë½ ì‹œ ëŸ°íƒ€ì„ ì—ëŸ¬
```

## ğŸ›¡ï¸ ì½”ë“œ ë¦¬ë·° ì‹œ í™•ì¸ì‚¬í•­

### 1. ëª¨ë“  DB ì¡°íšŒ í•¨ìˆ˜ í™•ì¸
- [ ] `getCurrentUserId()` í˜¸ì¶œì´ ìˆëŠ”ê°€?
- [ ] `.eq('user_id', userId)` í•„í„°ë§ì´ ìˆëŠ”ê°€?
- [ ] ì¡°ì¸ ì¿¼ë¦¬ì—ì„œë„ user_id í•„í„°ë§ì´ ìˆëŠ”ê°€?

### 2. ì„¸ì…˜ ì ‘ê·¼ í•¨ìˆ˜ í™•ì¸
- [ ] ì„¸ì…˜ ì†Œìœ ê¶Œ ê²€ì¦ì´ ìˆëŠ”ê°€?
- [ ] `session.user_id !== userId` ì²´í¬ê°€ ìˆëŠ”ê°€?
- [ ] ê¶Œí•œ ì—†ëŠ” ì ‘ê·¼ ì‹œ ì—ëŸ¬ë¥¼ ë˜ì§€ëŠ”ê°€?

### 3. Edge Function í™•ì¸
- [ ] ì…ë ¥ íŒŒë¼ë¯¸í„° ê²€ì¦ì´ ìˆëŠ”ê°€?
- [ ] í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ì´ ìˆëŠ”ê°€?
- [ ] ê° ë‹¨ê³„ë³„ ë¡œê¹…ì´ ìˆëŠ”ê°€?

### 4. ì‚­ì œ/ìˆ˜ì • í•¨ìˆ˜ í™•ì¸
- [ ] ì†Œìœ ê¶Œ ê²€ì¦ì´ ìˆëŠ”ê°€?
- [ ] `.eq('user_id', userId)` ì¡°ê±´ì´ ìˆëŠ”ê°€?
- [ ] ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ì—†ëŠ”ê°€?

## âš ï¸ ìœ„í—˜ ì‹ í˜¸ ê°ì§€

### ì½”ë“œì—ì„œ ë°œê²¬ ì‹œ ì¦‰ì‹œ ìˆ˜ì •
1. `getCurrentUserId()` í˜¸ì¶œ ì—†ì´ DB ì¡°íšŒ
2. `.eq('user_id', userId)` í•„í„°ë§ ì—†ìŒ
3. `vw_stats_by_type` ë·° ì§ì ‘ ì‚¬ìš©
4. ì„¸ì…˜ ì†Œìœ ê¶Œ ê²€ì¦ ì—†ìŒ
5. í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì—†ìŒ
6. ì…ë ¥ íŒŒë¼ë¯¸í„° ê²€ì¦ ì—†ìŒ