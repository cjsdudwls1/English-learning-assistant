---
alwaysApply: true
description: ë³´ì•ˆ ê´€ë ¨ ì ˆëŒ€ ìœ„ë°˜ ê¸ˆì§€ ì‚¬í•­
---

# ë³´ì•ˆ ìœ„ë°˜ ë°©ì§€ ê·œì¹™ (ì ˆëŒ€ ìœ„ë°˜ ê¸ˆì§€)

## ğŸš¨ CRITICAL: ì‚¬ìš©ì ë°ì´í„° ê²©ë¦¬ (ì ˆëŒ€ ìœ„ë°˜ ê¸ˆì§€)

### fetchUserSessions() í•¨ìˆ˜
```typescript
// âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„ (ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€)
.eq('user_id', userId)

// âŒ ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ
.eq('user_id', userId) // ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬
```

### fetchStatsByType() í•¨ìˆ˜
```typescript
// âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„ (ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€)
.eq('problems.sessions.user_id', userId)

// âŒ ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ
// user_id í•„í„°ë§ ì œê±°
// vw_stats_by_type ë·° ì§ì ‘ ì‚¬ìš©
```

### fetchSessionProblems() í•¨ìˆ˜
```typescript
// âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„ (ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€)
const { data: session, error: sessionError } = await supabase
  .from('sessions')
  .select('user_id')
  .eq('id', sessionId)
  .single();

if (sessionError) throw sessionError;
if (session.user_id !== userId) {
  throw new Error('ì´ ì„¸ì…˜ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
}

// âŒ ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ
// ì†Œìœ ê¶Œ ê²€ì¦ ì œê±°
// user_id í™•ì¸ ì—†ì´ ë°”ë¡œ ì¡°íšŒ
```

### deleteSession() í•¨ìˆ˜
```typescript
// âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„ (ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€)
.eq('id', sessionId)
.eq('user_id', userId)

// âŒ ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ
// user_id ì¡°ê±´ ì œê±°
.eq('id', sessionId) // ì´ê²ƒë§Œìœ¼ë¡œëŠ” ì•ˆë¨!
```

## ğŸ”’ Edge Function ë³´ì•ˆ ì›ì¹™

### Edge Function ì…ë ¥ ê²€ì¦ (ì ˆëŒ€ ì œê±° ê¸ˆì§€)
```typescript
// âœ… í•„ìˆ˜ ê²€ì¦ (ì ˆëŒ€ ì œê±° ê¸ˆì§€)
if (!imageBase64 || !userId) {
  console.log('Missing required fields');
  return new Response(JSON.stringify({ error: 'Missing required fields: imageBase64, userId' }), { 
    status: 400, 
    headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
  });
}
```

### í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ (ì ˆëŒ€ ì œê±° ê¸ˆì§€)
```typescript
// âœ… í•„ìˆ˜ ê²€ì¦ (ì ˆëŒ€ ì œê±° ê¸ˆì§€)
if (!supabaseUrl || !supabaseServiceKey) {
  throw new Error('Missing Supabase environment variables');
}

if (!geminiApiKey) {
  throw new Error('GEMINI_API_KEY environment variable is not set');
}
```

## ğŸ›¡ï¸ ë°°í¬ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë³€ê²½ ì „ í•„ìˆ˜ í™•ì¸ì‚¬í•­
1. **user_id í•„í„°ë§ í™•ì¸**: ëª¨ë“  DB ì¡°íšŒì— user_id í•„í„°ë§ì´ ìˆëŠ”ê°€?
2. **ì†Œìœ ê¶Œ ê²€ì¦ í™•ì¸**: ì„¸ì…˜ ì ‘ê·¼/ìˆ˜ì •/ì‚­ì œì— ì†Œìœ ê¶Œ ê²€ì¦ì´ ìˆëŠ”ê°€?
3. **Edge Function ë°°í¬ í™•ì¸**: ìˆ˜ì •ëœ ì½”ë“œê°€ Supabaseì— ë°°í¬ë˜ì—ˆëŠ”ê°€?

### ë³€ê²½ í›„ í•„ìˆ˜ í…ŒìŠ¤íŠ¸
1. **ë‹¤ë¥¸ ì‚¬ìš©ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸**: ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„°ê°€ ë³´ì´ì§€ ì•ŠëŠ”ê°€?
2. **í†µê³„ í˜ì´ì§€ í™•ì¸**: ë³¸ì¸ ë°ì´í„°ë§Œ í‘œì‹œë˜ëŠ”ê°€?
3. **ì„¸ì…˜ ì ‘ê·¼ í…ŒìŠ¤íŠ¸**: ë‹¤ë¥¸ ì‚¬ìš©ì ì„¸ì…˜ì— ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ”ê°€?

## âš ï¸ ìœ„ë°˜ ì‹œ ì¦‰ì‹œ ì¡°ì¹˜

### ë°ì´í„° ê³µìœ  ë°œê²¬ ì‹œ
1. ì¦‰ì‹œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨
2. ëª¨ë“  ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ê°•ì œ
3. ì½”ë“œ ìˆ˜ì • í›„ ì¬ë°°í¬
4. ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬ ì¬ê²€ì¦

### Edge Function ì‹¤íŒ¨ ì‹œ
1. Supabase ë¡œê·¸ í™•ì¸
2. í™˜ê²½ ë³€ìˆ˜ ì¬í™•ì¸
3. Edge Function ì¬ë°°í¬
4. ë‹¨ê³„ë³„ ë¡œê¹… í™•ì¸

## ğŸ¯ ì¬ë°œ ë°©ì§€ í•µì‹¬ ì›ì¹™

1. **ì ˆëŒ€ ê·œì¹™**: user_id í•„í„°ë§ ì—†ì´ëŠ” ì–´ë–¤ ë°ì´í„°ë„ ì¡°íšŒí•˜ì§€ ë§ ê²ƒ
2. **ì´ì¤‘ ê²€ì¦**: RLS + ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ í•„í„°ë§
3. **ë°°í¬ ê²€ì¦**: ì½”ë“œ ë³€ê²½ ì‹œ ë°˜ë“œì‹œ ë‹¤ì¤‘ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸
4. **ë¡œê¹… í•„ìˆ˜**: ëª¨ë“  ë³´ì•ˆ ê´€ë ¨ ì‘ì—…ì— ë¡œê¹… ì¶”ê°€