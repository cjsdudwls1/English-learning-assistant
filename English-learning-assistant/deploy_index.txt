// @ts-nocheck
import "jsr:@supabase/functions-js/edge-runtime.d.ts"
import { GoogleGenAI } from "https://esm.sh/@google/genai@1.21.0"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

// ?먮윭 ?뚯떛 ?⑥닔 (?몃씪?몄쑝濡??ы븿)
function parseApiError(error: unknown): { message: string; code: number; status: string } {
  // Error 媛앹껜??寃쎌슦
  if (error instanceof Error) {
    const message = error.message;
    
    // JSON 臾몄옄?댁씤 寃쎌슦 ?뚯떛 ?쒕룄
    if (message.includes('{') && message.includes('}')) {
      try {
        const parsed = JSON.parse(message);
        if (parsed.error) {
          const errorObj = parsed.error;
          return {
            message: errorObj.message || message,
            code: errorObj.code || errorObj.status || 500,
            status: String(errorObj.status || 'UNAVAILABLE')
          };
        }
      } catch {
        // JSON ?뚯떛 ?ㅽ뙣 ???먮낯 硫붿떆吏 ?ъ슜
      }
    }
    
    // ??꾩븘???먮윭 ?뺤씤
    if (message.includes('timeout') || message.includes('Timeout') || message.includes('TIMEOUT')) {
      return {
        message: 'Request timeout: The AI service took too long to respond. Please try generating fewer problems at once.',
        code: 504,
        status: 'TIMEOUT'
      };
    }
    
    return {
      message,
      code: 500,
      status: 'ERROR'
    };
  }
  
  // 媛앹껜 ?뺥깭???먮윭 泥섎━
  const err = error as any;
  
  // 以묒꺽??error 媛앹껜 泥섎━
  let errorMessage = 'Unknown error';
  let errorCode = 500;
  let errorStatus = 'UNAVAILABLE';
  
  // ?ㅼ뼇???먮윭 援ъ“ 吏??  if (err?.error) {
    const errorObj = err.error;
    errorMessage = errorObj.message || errorObj.error?.message || errorMessage;
    errorCode = errorObj.code || errorObj.status || errorCode;
    errorStatus = errorObj.status || errorStatus;
  } else {
    errorMessage = err?.message || err?.error?.message || err?.error?.error?.message || err?.details?.[0]?.message || errorMessage;
    errorCode = err?.code || err?.status || err?.error?.code || err?.error?.status || errorCode;
    errorStatus = err?.status || err?.error?.status || errorStatus;
  }
  
  // ?レ옄媛 ?꾨땶 寃쎌슦 ?뚯떛 ?쒕룄
  if (typeof errorCode !== 'number') {
    const parsedCode = parseInt(String(errorCode));
    if (!isNaN(parsedCode)) {
      errorCode = parsedCode;
    }
  }
  
  return {
    message: errorMessage,
    code: errorCode,
    status: String(errorStatus)
  };
}

// EdgeRuntime ????뺤쓽 (Supabase Edge Functions?먯꽌 ?쒓났)
declare const EdgeRuntime: {
  waitUntil(promise: Promise<any>): void;
};

// 怨듭쑀 ?좏떥由ы떚 ?⑥닔??function requireEnv(name: string): string {
  const value = Deno.env.get(name);
  if (!value) {
    throw new Error(`${name} environment variable is not set`);
  }
  return value;
}

function createServiceSupabaseClient() {
  const supabaseUrl = requireEnv('SUPABASE_URL');
  const supabaseServiceKey = requireEnv('SUPABASE_SERVICE_ROLE_KEY');
  return createClient(supabaseUrl, supabaseServiceKey);
}

const CORS_HEADERS = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, GET, OPTIONS, PUT, DELETE',
  'Access-Control-Max-Age': '86400',
};

function jsonResponse<T>(body: T, status = 200): Response {
  return new Response(JSON.stringify(body), {
    status,
    headers: { ...CORS_HEADERS, 'Content-Type': 'application/json' },
  });
}

function errorResponse(message: string, status = 500, details?: unknown): Response {
  return jsonResponse({ error: message, details }, status);
}

function handleOptions(): Response {
  return new Response(null, { status: 200, headers: CORS_HEADERS });
}

// Taxonomy ?곗씠?곕? DB?먯꽌 ?숈쟻?쇰줈 濡쒕뱶?섎뒗 ?⑥닔
async function loadTaxonomyData(supabase: any, language: 'ko' | 'en' = 'ko'): Promise<{ structure: string; allValues: { depth1: string[]; depth2: string[]; depth3: string[]; depth4: string[] } }> {
  console.log('Loading taxonomy data from database...', { language });
  
  const depth1Col = language === 'en' ? 'depth1_en' : 'depth1';
  const depth2Col = language === 'en' ? 'depth2_en' : 'depth2';
  const depth3Col = language === 'en' ? 'depth3_en' : 'depth3';
  const depth4Col = language === 'en' ? 'depth4_en' : 'depth4';
  
  const { data, error } = await supabase
    .from('taxonomy')
    .select(`${depth1Col}, ${depth2Col}, ${depth3Col}, ${depth4Col}`)
    .order(`${depth1Col}, ${depth2Col}, ${depth3Col}, ${depth4Col}`);
  
  if (error) {
    console.error('Error loading taxonomy:', error);
    throw error;
  }
  
  // 怨꾩링 援ъ“濡?蹂??  const structure: any = {};
  const allValues: { depth1: Set<string>; depth2: Set<string>; depth3: Set<string>; depth4: Set<string> } = {
    depth1: new Set(),
    depth2: new Set(),
    depth3: new Set(),
    depth4: new Set(),
  };
  
  for (const row of data || []) {
    const d1 = row[depth1Col] || '';
    const d2 = row[depth2Col] || '';
    const d3 = row[depth3Col] || '';
    const d4 = row[depth4Col] || '';
    
    if (d1) allValues.depth1.add(d1);
    if (d2) allValues.depth2.add(d2);
    if (d3) allValues.depth3.add(d3);
    if (d4) allValues.depth4.add(d4);
    
    if (!structure[d1]) structure[d1] = {};
    if (!structure[d1][d2]) structure[d1][d2] = {};
    if (!structure[d1][d2][d3]) structure[d1][d2][d3] = [];
    if (d4 && !structure[d1][d2][d3].includes(d4)) {
      structure[d1][d2][d3].push(d4);
    }
  }
  
  // 臾몄옄?대줈 蹂??  function formatStructure(obj: any, indent = 0): string {
    let result = '';
    const spaces = '  '.repeat(indent);
    
    for (const [key, value] of Object.entries(obj)) {
      result += spaces + key + '\n';
      if (typeof value === 'object' && !Array.isArray(value)) {
        result += formatStructure(value, indent + 1);
      } else if (Array.isArray(value)) {
        value.forEach((item: string) => {
          result += spaces + '  ' + item + '\n';
        });
      }
    }
    
    return result;
  }
  
  const taxonomyTree = formatStructure(structure);
  console.log('Taxonomy data loaded:', taxonomyTree.substring(0, 200) + '...');
  
  return {
    structure: taxonomyTree,
    allValues: {
      depth1: Array.from(allValues.depth1).sort(),
      depth2: Array.from(allValues.depth2).sort(),
      depth3: Array.from(allValues.depth3).sort(),
      depth4: Array.from(allValues.depth4).sort(),
    },
  };
}

// depth1~4濡?taxonomy 議고쉶?섏뿬 code, CEFR, ?쒖씠??李얘린
async function findTaxonomyByDepth(
  supabase: any,
  depth1: string,
  depth2: string,
  depth3: string,
  depth4: string,
  language: 'ko' | 'en' = 'ko'
): Promise<{ code: string | null; cefr: string | null; difficulty: number | null }> {
  const depth1Col = language === 'en' ? 'depth1_en' : 'depth1';
  const depth2Col = language === 'en' ? 'depth2_en' : 'depth2';
  const depth3Col = language === 'en' ? 'depth3_en' : 'depth3';
  const depth4Col = language === 'en' ? 'depth4_en' : 'depth4';
  
  const { data, error } = await supabase
    .from('taxonomy')
    .select('code, cefr, difficulty')
    .eq(depth1Col, depth1)
    .eq(depth2Col, depth2)
    .eq(depth3Col, depth3)
    .eq(depth4Col, depth4)
    .single();
  
  if (error || !data) {
    if (error && error.code !== 'PGRST116') {
      console.warn('Taxonomy lookup error:', error);
    }
    return { code: null, cefr: null, difficulty: null };
  }
  
  return {
    code: data.code || null,
    cefr: data.cefr || null,
    difficulty: data.difficulty || null,
  };
}

function buildPrompt(classificationData: { structure: string; allValues: { depth1: string[]; depth2: string[]; depth3: string[]; depth4: string[] } }, language: 'ko' | 'en' = 'ko') {
  const { structure, allValues } = classificationData;
  
  // ?몄뼱???곕씪 ?꾨＼?꾪듃 ?몄뼱 蹂寃?(?꾩옱???쒓뎅???꾨＼?꾪듃留??덉쑝誘濡??곸뼱???뚮뒗 ?곸뼱濡?踰덉뿭 ?꾩슂)
  const isEnglish = language === 'en';
  
  return `
### 1. ?섎Ⅴ?뚮굹 (Persona) ###
?뱀떊? ??媛吏 ?꾨Ц?깆쓣 寃몃퉬??理쒓퀬 ?섏???AI ?꾨Ц媛?낅땲??
1.  **?먭???OCR ?꾨Ц媛**: 遺덇퇋移숉븳 ?꾧린, 寃뱀퀜 ??湲?? ?ㅼ뼇???꾧린援ъ쓽 ?붿쟻源뚯? 遺꾩꽍?섏뿬 ?붿????띿뒪?몃줈 蹂?섑븯?????뱁솕?섏뼱 ?덉뒿?덈떎. ?쒖쓽 ?뺣젰, 湲곗슱湲? ?띿쓽 ?곌껐?깃낵 媛숈? 誘몄꽭???뱀쭠???뚯븙?섏뿬 臾몃㎘ 湲곕컲?쇰줈 紐⑦샇??湲?먮? 異붾줎?섎뒗 ?λ젰???곗뼱?⑸땲??
2.  **?곸뼱 援먯쑁 ?됯? ?꾨Ц媛**: ?ㅼ뼇???좏삎???곸뼱 臾몄젣瑜??댄빐?섍퀬, 援먯쑁怨쇱젙 遺꾨쪟 泥닿퀎???곕씪 臾몄젣???듭떖 ?섎룄瑜??뚯븙?섏뿬 ?뺥솗?섍쾶 遺꾨쪟?????덉뒿?덈떎.

### 2. 怨쇱뾽 (Task) ###
?ъ슜?먭? ?낅줈?쒗븳 ?곸뼱 臾몄젣 ?대?吏 ???μ쓣 醫낇빀?곸쑝濡?遺꾩꽍?섏뿬, ?대?吏 ?댁쓽 紐⑤뱺 ?띿뒪?몄? ?먭??⑤? ?몄떇?섍퀬, 臾몄젣 ?좏삎??遺꾨쪟???? 遺꾩꽍??紐⑤뱺 ?뺣낫瑜?吏?뺣맂 JSON ?뺤떇??留욎떠 ???섎굹??寃곌낵臾쇰줈 異쒕젰?댁빞 ?⑸땲??

### 3. 留λ씫 (Context) ###
- **?낅젰 ?곗씠??1 (?대?吏)**: ?ъ슜?먭? 珥ъ쁺?섍굅???낅줈?쒗븳 ?곸뼱 臾몄젣 ?대?吏 ?뚯씪. ???대?吏?먮뒗 ?몄뇙??臾몄젣 ?띿뒪?? 媛앷???蹂닿린, 洹몃━怨??ъ슜?먭? ?먯쑝濡??묒꽦???듭븞 諛?梨꾩젏 ?쒖떆(O, X, ?? ?? 痍⑥냼????媛 ?ы븿?섏뼱 ?덉뒿?덈떎.
- **?낅젰 ?곗씠??2 (遺꾨쪟 湲곗???**: 臾몄젣 ?좏삎??遺꾨쪟?섍린 ?꾪븳 湲곗????섎뒗 ?곗씠?곗엯?덈떎.

**遺꾨쪟 湲곗???怨꾩링 援ъ“:**
\`\`\`
${structure}
\`\`\`

**?좑툘 ?덈? 洹쒖튃:**
- ??怨꾩링 援ъ“???섏??덈뒗 ?뺥솗??depth1, depth2, depth3, depth4 媛믩쭔 ?ъ슜?섏꽭??
- 怨듬갚?대굹 ?뱀닔臾몄옄(쨌)瑜?蹂寃쏀븯吏 留덉꽭?? (?? ??"臾몄옣?좏삎" ????"臾몄옣 ?좏삎쨌?쒖젣쨌??)
- ?꾩쓽??媛믪씠???쎌뼱瑜??ъ슜?섏? 留덉꽭?? (?? ??"?댄쐶" ????"?댄쐶쨌?곌껐")
- 怨꾩링 援ъ“瑜??뺥솗???곕씪???⑸땲??(depth1 ??depth2 ??depth3 ??depth4).

### 4. ?④퀎蹂?吏??(Step-by-Step Instructions / Chain-of-Thought) ###
?ㅼ쓬 ?④퀎瑜??쒖꽌?濡? 洹몃━怨??좎쨷?섍쾶 ?섑뻾?섏뿬 理쒖쥌 寃곌낵臾쇱쓣 ?꾩텧?섏꽭??

**[1?④퀎: ?대?吏 ?꾩쿂由?諛??곸뿭 援щ텇]**
- ?대?吏 ?꾩껜瑜??ㅼ틪?섏뿬 ?몄뇙???띿뒪???곸뿭(臾몄젣 蹂몃Ц, 蹂닿린)怨??먭??④? ?덉쓣 媛?μ꽦???믪? ?곸뿭(?듭븞 ?묒꽦?, 梨꾩젏 留덊궧 ?곸뿭)??紐낇솗?섍쾶 援щ텇?섏꽭??

**[2?④퀎: ?띿뒪??諛?留덊궧 ?몄떇]**
- **?몄뇙 ?띿뒪??異붿텧**: 臾몄젣 蹂몃Ц怨?媛앷???蹂닿린(?? ?? ?? ?? ?? ?? ?띿뒪?몃? ?뺥솗?섍쾶 異붿텧?⑸땲??
- **?먭????듭븞 ?몄떇**:
    - **而⑦뀓?ㅽ듃 ?쒖슜**: 二쇰? ?몄뇙 ?띿뒪??臾몄젣 ?댁슜)??留λ씫怨??쇰컲?곸씤 ?곸뼱 臾몃쾿 洹쒖튃???쒖슜?섏뿬 ?ъ슜?먭? ?묒꽦???듭븞??異붾줎?⑸땲??
    - **?뱀쭠 遺꾩꽍**: ?띿쓽 ?쒖옉?? ?앹젏, 湲??媛?媛꾧꺽, ?ш린 鍮꾩쑉??遺꾩꽍?섏뿬 ?좎궗 臾몄옄(?? 1/l, 0/O, 5/S)瑜??뺣??섍쾶 援щ텇?⑸땲??
    - **?ㅼ쨷 ?댁꽍 泥섎━**: 留뚯빟 ?먭??④? 遺덈챸?뺥븯???щ윭 媛吏濡??댁꽍?????덈떎硫??? '3'?몄? '5'?몄? 紐⑦샇??寃쎌슦), 媛??媛?μ꽦???믪? ?듭쓣 湲곕낯媛믪쑝濡??섎릺, 媛?ν븳 紐⑤뱺 ?泥??댁꽍???섏쭛???〓땲??
- **梨꾩젏 留덊궧 ?몄떇**: ?대?吏???쒖떆??梨꾩젏 留덊겕瑜??몄떇?섎릺, 理쒖쥌 異쒕젰?먯꽌??諛섎뱶???ㅼ쓬 洹쒖튃???곕쫭?덈떎.
    - 理쒖쥌 媛믪? ?ㅼ쭅 "O" ?먮뒗 "X" ??以??섎굹留??ъ슜?⑸땲??
    - ?먰삎/泥댄겕/?뺣떟 ?쒖떇? 紐⑤몢 "O"濡??듭씪?⑸땲??
    - 援먯감???ㅻ떟 ?쒖떇? 紐⑤몢 "X"濡??듭씪?⑸땲??
    - 洹????쒖떇(?? 痍⑥냼??????蹂댁씠?붾씪???곹솴 ?먮떒?섏뿬 "O" ?먮뒗 "X" 以??섎굹濡?寃곗젙?⑸땲??

**[3?④퀎: 臾몄젣 ?좏삎 遺꾨쪟]**
- [2?④퀎]?먯꽌 異붿텧??臾몄젣 ?띿뒪?몃? 湲곕컲?쇰줈, 二쇱뼱吏?遺꾨쪟 湲곗??쒕? 李몄“?섏뿬 臾몄젣???좏삎??"1Depth"遺??"4Depth"源뚯? 遺꾨쪟?⑸땲??
- 遺꾨쪟???뺥솗?꾩뿉 ????먯껜?곸씤 ?좊ː?꾨? '?믪쓬', '蹂댄넻', '??쓬' 以??섎굹濡??됯??섍퀬, ??洹몃젃寃?遺꾨쪟?덈뒗吏?????援ъ껜?곸씤 洹쇨굅瑜???臾몄옣?쇰줈 ?붿빟?⑸땲??

**[4?④퀎: ?꾩쿂由?諛??좊ː???됯?]**
- ?몄떇??紐⑤뱺 ?띿뒪???뱁엳 ?먭?????????곸뼱 ?ъ쟾??湲곕컲?쇰줈 留욎땄踰?援먯젙???쒕룄?⑸땲?? 留뚯빟 ?⑥뼱瑜?援먯젙?덈떎硫? ?대떦 ?ъ떎??湲곕줉???〓땲??
- 異붿텧 諛?遺꾩꽍??媛??곗씠????ぉ(臾몄젣?댁슜, ?ъ슜???듭븞 ???????媛쒕퀎?곸씤 ?몄떇 ?좊ː??Confidence Score)瑜?諛깅텇?⑤줈 ?됯??⑸땲??

### 5. 異쒕젰 紐낆꽭 (Output Specification) ###
?대?吏 ???μ뿉 ?щ윭 臾명빆???덉쓣 ???덉쑝誘濡? 諛섎뱶???꾨옒 援ъ“??JSON 媛앹껜 ?섎굹留?異쒕젰?섏꽭??

\`\`\`json
{
  "items": [
    {
      "index": 0,
      "?ъ슜?먭?_吏곸젒_梨꾩젏???뺤삤??: "O | X",
      "臾몄젣?댁슜": { "text": "...", "confidence_score": 0.98 },
      "臾몄젣_蹂닿린": [ { "text": "??...", "confidence_score": 0.99 } ],
      "?ъ슜?먭?_湲곗닠???뺣떟": {
        "text": "...",
        "confidence_score": 0.85,
        "auto_corrected": false,
        "alternate_interpretations": ["..."]
      },
      "臾몄젣_?좏삎_遺꾨쪟": {
        "1Depth": "...",
        "2Depth": "...",
        "3Depth": "...",
        "4Depth": "...",
        "遺꾨쪟_?좊ː??: "?믪쓬"
      },
      "遺꾨쪟_洹쇨굅": "..."
    }
  ]
}
\`\`\`

### 6. ?쒖빟 諛??덉쇅 泥섎━ (Constraints & Error Handling) ###
- **?대?吏 ?덉쭏 ???*: ?대?吏媛 ?덈Т ?먮┸?섍굅??鍮?諛섏궗媛 ?ы빐 ?댁슜???먮룆?????녿뒗 寃쎌슦, JSON??紐⑤뱺 媛믪쓣 "?몄떇遺덇?"濡?梨꾩슦?몄슂.
- **鍮꾩쁺??臾몄젣**: 遺꾩꽍 寃곌낵, ?댁슜???곸뼱媛 ?꾨땲?쇨퀬 ?먮떒?섎㈃ JSON??紐⑤뱺 媛믪쓣 "?곸뼱 臾몄젣 ?꾨떂"?쇰줈 梨꾩슦?몄슂.
- **遺꾨쪟 紐⑦샇??*: 臾몄젣 ?좏삎 遺꾨쪟媛 ?좊ℓ?섏뿬 ??媛??댁긽??移댄뀒怨좊━??嫄몄퀜 ?덈떎怨??먮떒??寃쎌슦, 媛??媛?μ꽦???믪? ?섎굹瑜??좏깮?섎릺, "遺꾨쪟_?좊ː??瑜?"??쓬"?쇰줈 ?ㅼ젙?섏꽭??
- **遺덊븘?뷀븳 ?뺣낫**: ?꾨＼?꾪듃??紐낆떆?섏? ?딆? ?대뼚???뺣낫??異붽?濡??앹꽦?섍굅??異쒕젰?섏? 留덉꽭??
`;

function normalizeMark(raw: unknown): 'O' | 'X' {
  if (raw === undefined || raw === null) return 'X';
  const value = String(raw).trim().toLowerCase();
  const truthy = new Set(['o', '??, 'v', 'correct', 'true', '?뺣떟', '留욎쓬', 'ok', '狩?, 'circle', 'check', 'checkmark']);
  if (truthy.has(value)) return 'O';
  return 'X';
}

// 諛깃렇?쇱슫???묒뾽 ?⑥닔: Gemini API ?몄텧 諛?DB ???async function analyzeImageInBackground(
  sessionId: string,
  imageBase64: string,
  mimeType: string,
  userLanguage: 'ko' | 'en',
  geminiApiKey: string
): Promise<void> {
  const supabase = createServiceSupabaseClient();
  
  try {
    // 3. Taxonomy ?곗씠??濡쒕뱶
    console.log('[Background] Step 3a: Loading taxonomy data from database...', { language: userLanguage });
    const taxonomyData = await loadTaxonomyData(supabase, userLanguage);
    const prompt = buildPrompt(taxonomyData, userLanguage);
    
    // 3. Gemini API濡?遺꾩꽍 (?ъ떆??濡쒖쭅 ?곸슜)
    console.log('[Background] Step 3b: Analyzing image with Gemini...');
    const ai = new GoogleGenAI({ apiKey: geminiApiKey });

    const imagePart = { inlineData: { data: imageBase64, mimeType } };
    const textPart = { text: prompt };

    let responseText: string;
    
    // ?ъ떆???ㅼ젙
    const MAX_RETRIES = 5; // 理쒕? 5踰덇퉴吏 ?ъ떆??    const BASE_DELAY = 5000; // 湲곕낯 5珥??湲?(?쒕쾭 蹂듦뎄 ?쒓컙 怨좊젮)

    let attempt = 0;
    while (attempt < MAX_RETRIES) {
      try {
        const timeoutMs = 50000; // 50珥???꾩븘??        const timeoutPromise = new Promise<never>((_, reject) => {
          setTimeout(() => reject(new Error('Gemini API request timeout')), timeoutMs);
        });
        
        const apiPromise = ai.models.generateContent({
          model: 'gemini-2.5-flash',
          contents: { parts: [textPart, imagePart] },
        });
        
        console.log(`[Background] Attempt ${attempt + 1}/${MAX_RETRIES}: Starting Gemini API call with ${timeoutMs/1000}s timeout...`);
        const startTime = Date.now();
        
        const response = await Promise.race([apiPromise, timeoutPromise]);
        const elapsedTime = Date.now() - startTime;
        
        console.log(`[Background] Gemini API call completed in ${elapsedTime}ms`);
        responseText = response.text;
        console.log('[Background] Step 3 completed: Gemini response received, length:', responseText.length);
        
        // ?깃났?덉쑝硫?諛섎났臾??덉텧
        break;
      } catch (apiError: any) {
        attempt++;
        
        // ?먮윭 ?뺣낫 ?곸꽭 濡쒓퉭
        console.error(`[Background] Gemini API error (attempt ${attempt}/${MAX_RETRIES}):`, apiError);
        console.error(`[Background] Error type:`, typeof apiError);
        console.error(`[Background] Error keys:`, apiError ? Object.keys(apiError) : 'N/A');
        if (apiError?.error) {
          console.error(`[Background] Nested error:`, apiError.error);
        }
        
        // ?먮윭 ?뺣낫 ?뚯떛 (怨듯넻 ?좏떥由ы떚 ?ъ슜)
        const parsedError = parseApiError(apiError);
        const errorMessage = parsedError.message;
        const errorCode = parsedError.code;
        const errorStatus = parsedError.status;
        
        console.log(`[Background] Parsed error - code: ${errorCode}, status: ${errorStatus}, message: ${errorMessage.substring(0, 100)}`);
        
        const isRateLimit = errorCode === 429 || errorMessage.includes('429') || errorMessage.toLowerCase().includes('rate limit') || errorMessage.toLowerCase().includes('quota');
        const isServerOverload = errorCode === 503 || errorMessage.includes('503') || errorMessage.toLowerCase().includes('overloaded') || errorMessage.toLowerCase().includes('unavailable') || errorStatus === 'UNAVAILABLE';
        const isTimeout = errorMessage.includes('timeout') || errorMessage.includes('Timeout') || errorMessage.includes('TIMEOUT') || errorCode === 504;
        
        console.log(`[Background] Error classification - RateLimit: ${isRateLimit}, ServerOverload: ${isServerOverload}, Timeout: ${isTimeout}`);
        
        // 留덉?留??쒕룄?嫄곕굹, ?ъ떆?꾪븷 媛移섍? ?녿뒗 ?먮윭?쇰㈃ throw
        if (attempt >= MAX_RETRIES || (!isRateLimit && !isServerOverload && !isTimeout)) {
          console.error(`[Background] Gemini API failed after ${attempt} attempts:`, { code: errorCode, status: errorStatus, message: errorMessage });
          throw new Error(`Gemini API error: ${errorMessage}`);
        }
        
        // 429, 503, ?먮뒗 ??꾩븘?껋씠硫??좎떆 ?湲????ъ떆??(Exponential Backoff)
        // 1踰덉㎏: 5珥? 2踰덉㎏: 10珥? 3踰덉㎏: 20珥? 4踰덉㎏: 40珥??湲?        const delay = BASE_DELAY * Math.pow(2, attempt - 1);
        console.warn(`[Background] Hit rate limit/overload/timeout (code: ${errorCode}, status: ${errorStatus}). Retrying in ${delay/1000}s... (Attempt ${attempt}/${MAX_RETRIES})`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
    
    // JSON ?뚯떛
    const jsonString = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
    let result: any;
    try {
      result = JSON.parse(jsonString);
    } catch (parseError) {
      console.error('[Background] JSON parsing error:', parseError);
      console.error('[Background] Response text:', responseText.substring(0, 500));
      throw new Error(`Failed to parse AI response as JSON: ${parseError instanceof Error ? parseError.message : 'Unknown parsing error'}`);
    }

    if (!result || !Array.isArray(result.items)) {
      throw new Error('AI ?묐떟 ?뺤떇 ?ㅻ쪟: items 諛곗뿴???놁뒿?덈떎.');
    }

    console.log(`[Background] Step 3 completed: Parsed ${result.items.length} items from analysis`);

    // 4. 臾몄젣 ???    console.log('[Background] Step 4: Save problems to database...');
    const items = result.items;
    const problemsPayload = items.map((it: any, idx: number) => ({
      session_id: sessionId,
      index_in_image: it.index ?? idx,
      stem: it.臾몄젣?댁슜?.text || '',
      choices: (it.臾몄젣_蹂닿린 || []).map((c: any) => ({ text: c.text, confidence: c.confidence_score })),
    }));

    const { data: problems, error: problemsError } = await supabase
      .from('problems')
      .insert(problemsPayload)
      .select('id, index_in_image');

    if (problemsError) {
      console.error('[Background] Step 4 error: Problems insert error:', problemsError);
      throw problemsError;
    }

    console.log(`[Background] Step 4 completed: Inserted ${problems?.length || 0} problems`);

    // 5. AI 遺꾩꽍 寃곌낵瑜?labels?????(user_mark??null濡?- ?ъ슜??寃???湲?
    console.log('[Background] Step 5: Save AI analysis results to labels (pending user review)...');
    const idByIndex = new Map<number, string>();
    for (const row of problems || []) {
      idByIndex.set(row.index_in_image, row.id);
    }

    // 媛?臾몄젣?????taxonomy 議고쉶?섏뿬 code, CEFR, ?쒖씠??異붽?
    const labelsPayload = await Promise.all(items.map(async (it: any, idx: number) => {
      const normalizedMark = normalizeMark(it.?ъ슜?먭?_吏곸젒_梨꾩젏???뺤삤??;
      const classification = it.臾몄젣_?좏삎_遺꾨쪟 || {};
      
      // Gemini媛 諛섑솚???먮낯 媛?      const rawDepth1 = (classification['1Depth'] || '').trim();
      const rawDepth2 = (classification['2Depth'] || '').trim();
      const rawDepth3 = (classification['3Depth'] || '').trim();
      const rawDepth4 = (classification['4Depth'] || '').trim();
      
      // ?좏슚??寃利? DB???덈뒗 媛믪씤吏 ?뺤씤
      const validDepth1 = taxonomyData.allValues.depth1.includes(rawDepth1) ? rawDepth1 : '';
      const validDepth2 = taxonomyData.allValues.depth2.includes(rawDepth2) ? rawDepth2 : '';
      const validDepth3 = taxonomyData.allValues.depth3.includes(rawDepth3) ? rawDepth3 : '';
      const validDepth4 = taxonomyData.allValues.depth4.includes(rawDepth4) ? rawDepth4 : '';
      
      // ?좏슚?섏? ?딆? 媛믪씠 ?덉쑝硫?寃쎄퀬
      if (!validDepth1 && rawDepth1) {
        console.warn(`[Background] Invalid depth1: "${rawDepth1}" - not in taxonomy. Valid values: ${taxonomyData.allValues.depth1.slice(0, 3).join(', ')}...`);
      }
      if (!validDepth2 && rawDepth2) {
        console.warn(`[Background] Invalid depth2: "${rawDepth2}" - not in taxonomy`);
      }
      if (!validDepth3 && rawDepth3) {
        console.warn(`[Background] Invalid depth3: "${rawDepth3}" - not in taxonomy`);
      }
      if (!validDepth4 && rawDepth4) {
        console.warn(`[Background] Invalid depth4: "${rawDepth4}" - not in taxonomy`);
      }
      
      // ?좏슚??媛믪쑝濡쒕쭔 taxonomy 議고쉶
      const taxonomy = await findTaxonomyByDepth(
        supabase,
        validDepth1,
        validDepth2,
        validDepth3,
        validDepth4,
        userLanguage
      );
      
      // classification??code, CEFR, ?쒖씠??異붽? (?좏슚??媛믩쭔 ???
      const enrichedClassification = {
        '1Depth': validDepth1 || null,
        '2Depth': validDepth2 || null,
        '3Depth': validDepth3 || null,
        '4Depth': validDepth4 || null,
        code: taxonomy.code,
        CEFR: taxonomy.cefr,
        ?쒖씠?? taxonomy.difficulty,
        遺꾨쪟_?좊ː?? classification['遺꾨쪟_?좊ː??] || '蹂댄넻',
      };
      
      // ?좏슚?섏? ?딆? 媛믪씠 ?덇굅??留ㅽ븨 ?ㅽ뙣 ???좊ː???섎씫
      if (!validDepth1 || !taxonomy.code) {
        enrichedClassification['遺꾨쪟_?좊ː??] = '??쓬';
        if (!validDepth1) {
          console.warn(`[Background] Invalid classification: depth1="${rawDepth1}" is not in taxonomy. Saving with null.`);
        }
      }
      
      return {
        problem_id: idByIndex.get(it.index ?? idx)!,
        user_answer: it.?ъ슜?먭?_湲곗닠???뺣떟?.text || '',
        user_mark: null, // ?ъ슜??寃???꾩씠誘濡?null
        is_correct: normalizedMark === 'O', // AI 遺꾩꽍 寃곌낵 ???        classification: enrichedClassification,
        confidence: {
          stem: it.臾몄젣?댁슜?.confidence_score || 1.0,
          answer: it.?ъ슜?먭?_湲곗닠???뺣떟?.confidence_score || 1.0,
          choices: (it.臾몄젣_蹂닿린 || []).map((c: any) => c.confidence_score || 1.0),
        },
      };
    }));

    const { error: labelsError } = await supabase.from('labels').insert(labelsPayload);
    if (labelsError) {
      console.error('[Background] Step 5 error: Labels insert error:', labelsError);
      throw labelsError;
    }

    console.log('[Background] Step 5 completed: AI analysis results saved (pending user review)');

    // 6. 臾몄젣 硫뷀??곗씠???앹꽦 諛????    console.log('[Background] Step 6: Generate problem metadata...');
    const ai = new GoogleGenAI({ apiKey: geminiApiKey });
    
    // 媛?臾몄젣?????硫뷀??곗씠???앹꽦
    const metadataResults = await Promise.all(problems.map(async (p: any) => {
      const originalItem = items.find((it: any) => (it.index ?? items.indexOf(p)) === p.index_in_image);
      if (!originalItem) return null;

      const problemStem = originalItem.臾몄젣?댁슜?.text || '';
      const problemChoices = (originalItem.臾몄젣_蹂닿린 || []).map((c: any) => c.text).join('\n');
      const userAnswer = originalItem.?ъ슜?먭?_湲곗닠???뺣떟?.text || '';
      const isCorrect = normalizeMark(originalItem.?ъ슜?먭?_吏곸젒_梨꾩젏???뺤삤?? === 'O';

      // 硫뷀??곗씠???앹꽦 ?꾨＼?꾪듃
      const metadataPrompt = userLanguage === 'ko' 
        ? `?ㅼ쓬 ?곸뼱 臾몄젣瑜?遺꾩꽍?섏뿬 硫뷀??곗씠?곕? ?앹꽦?댁＜?몄슂.

臾몄젣 ?댁슜:
${problemStem}

?좏깮吏:
${problemChoices}

?ъ슜???듭븞: ${userAnswer}
?뺣떟 ?щ?: ${isCorrect ? '?뺣떟' : '?ㅻ떟'}

?ㅼ쓬 ?뺤떇??JSON?쇰줈 ?묐떟?댁＜?몄슂:
{
  "difficulty": "?? | "以? | "??,
  "word_difficulty": 1-9 ?ъ씠???レ옄,
  "problem_type": "臾몄젣 ?좏삎??????ㅻ챸 (?? 臾몃쾿, ?댄쐶, ?낇빐 ??",
  "analysis": "臾몄젣??????곸꽭 遺꾩꽍 ?뺣낫"
}

?쒖씠??湲곗?:
- ?? 怨좊벑?숆탳 ?섏? ?댁긽???대젮??臾몄젣
- 以? 以묓븰援??섏???臾몄젣
- ?? 珥덈벑?숆탳 ?섏????ъ슫 臾몄젣

?⑥뼱 ?쒖씠??湲곗?:
- 1-3: 珥덈벑?숆탳 ?섏????ъ슫 ?⑥뼱
- 4-6: 以묓븰援??섏???蹂댄넻 ?⑥뼱
- 7-9: 怨좊벑?숆탳 ?섏? ?댁긽???대젮???⑥뼱

JSON ?뺤떇?쇰줈留??묐떟?댁＜?몄슂.`
        : `Analyze the following English problem and generate metadata.

Problem:
${problemStem}

Choices:
${problemChoices}

User Answer: ${userAnswer}
Is Correct: ${isCorrect ? 'Correct' : 'Incorrect'}

Please respond in the following JSON format:
{
  "difficulty": "high" | "medium" | "low",
  "word_difficulty": number between 1-9,
  "problem_type": "Description of problem type (e.g., grammar, vocabulary, reading comprehension)",
  "analysis": "Detailed analysis of the problem"
}

Difficulty criteria:
- high: High school level or above
- medium: Middle school level
- low: Elementary school level

Word difficulty criteria:
- 1-3: Elementary school level words
- 4-6: Middle school level words
- 7-9: High school level or above words

Respond only in JSON format.`;

      try {
        const metadataResponse = await ai.models.generateContent({
          model: 'gemini-2.5-flash',
          contents: { parts: [{ text: metadataPrompt }] },
          generationConfig: {
            temperature: 0.0, // ?쇨???蹂댁옣
          },
        });

        const metadataText = metadataResponse.text;
        // JSON 異붿텧
        const jsonMatch = metadataText.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
          console.warn(`[Background] Failed to extract JSON from metadata response for problem ${p.id}`);
          return null;
        }

        const metadata = JSON.parse(jsonMatch[0]);
        
        // ?쒖씠??蹂??(?곸뼱 -> ?쒓뎅??
        if (userLanguage === 'en') {
          if (metadata.difficulty === 'high') metadata.difficulty = '??;
          else if (metadata.difficulty === 'medium') metadata.difficulty = '以?;
          else if (metadata.difficulty === 'low') metadata.difficulty = '??;
        }

        // 硫뷀??곗씠?????        const { error: updateError } = await supabase
          .from('problems')
          .update({ 
            problem_metadata: {
              difficulty: metadata.difficulty || '以?,
              word_difficulty: metadata.word_difficulty || 5,
              problem_type: metadata.problem_type || '',
              analysis: metadata.analysis || '',
            }
          })
          .eq('id', p.id);

        if (updateError) {
          console.error(`[Background] Error updating metadata for problem ${p.id}:`, updateError);
          return null;
        }

        console.log(`[Background] Metadata saved for problem ${p.id}`);
        return { problemId: p.id, success: true };
      } catch (error) {
        console.error(`[Background] Error generating/saving metadata for problem ${p.id}:`, error);
        return null;
      }
    }));

    console.log(`[Background] Step 6 completed: Generated metadata for ${metadataResults.filter(r => r !== null).length} problems`);

    // 7. ?몄뀡 ?곹깭瑜?completed濡??낅뜲?댄듃
    console.log('[Background] Step 7: Update session status to completed...');
    const { error: statusUpdateError } = await supabase
      .from('sessions')
      .update({ status: 'completed' })
      .eq('id', sessionId);

    if (statusUpdateError) {
      console.error('[Background] Step 7 error: Status update error:', statusUpdateError);
      // ?곹깭 ?낅뜲?댄듃 ?ㅽ뙣?대룄 遺꾩꽍? ?꾨즺?섏뿀?쇰?濡?怨꾩냽 吏꾪뻾
    } else {
      console.log('[Background] Step 7 completed: Session status updated to completed');
    }

    console.log('[Background] Background analysis completed for session:', sessionId);
  } catch (error) {
    console.error('[Background] Error in background task:', error);
    console.error('[Background] Error stack:', error instanceof Error ? error.stack : 'No stack trace');
    
    // 諛깃렇?쇱슫??遺꾩꽍 ?ㅽ뙣 ???몄뀡 ?곹깭瑜?failed濡??낅뜲?댄듃
    try {
      await supabase
        .from('sessions')
        .update({ status: 'failed' })
        .eq('id', sessionId);
      console.log('[Background] Session status updated to failed due to background error');
    } catch (statusError) {
      console.error('[Background] Failed to update session status to failed:', statusError);
    }
  }
}

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return handleOptions();
  }

  if (req.method !== 'POST') {
    return errorResponse('Method not allowed', 405);
  }

  let supabase = createServiceSupabaseClient();
  let createdSessionId: string | undefined;

  try {
    console.log('Edge Function called:', {
      method: req.method,
      url: req.url,
      hasBody: !!req.body,
    });

    const { imageBase64, mimeType, userId, fileName, language } = await req.json();
    console.log('Request data:', {
      hasImageBase64: !!imageBase64,
      mimeType,
      userId,
      fileName,
      language,
    });

    if (!imageBase64 || !userId) {
      console.log('Missing required fields');
      return errorResponse('Missing required fields: imageBase64, userId', 400);
    }

    const geminiApiKey = requireEnv('GEMINI_API_KEY');

    let userLanguage: 'ko' | 'en' = language === 'en' ? 'en' : 'ko';

    if (!language) {
      const { data: profile } = await supabase
        .from('profiles')
        .select('language')
        .eq('user_id', userId)
        .single();

      if (profile?.language === 'ko' || profile?.language === 'en') {
        userLanguage = profile.language as 'ko' | 'en';
      }
    }

    // 1. ?대?吏瑜?Storage???낅줈??    console.log('Step 1: Upload image to storage...');
    const timestamp = Date.now();
    const safeName = (fileName || 'image.jpg').replace(/[^a-zA-Z0-9_.-]/g, '_');
    const { data: userData } = await supabase.auth.admin.getUserById(userId);
    const email = userData.user?.email || userId;
    const emailLocal = email.split('@')[0].replace(/[^a-zA-Z0-9_-]/g, '_');
    const path = `${emailLocal}/${timestamp}_${safeName}`;
    
    const buffer = new Uint8Array(atob(imageBase64).split('').map(c => c.charCodeAt(0)));
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('problem-images')
      .upload(path, buffer, {
        contentType: mimeType,
        cacheControl: '3600',
        upsert: false
      });

    if (uploadError) throw uploadError;
    
    const { data: urlData } = supabase.storage.from('problem-images').getPublicUrl(uploadData.path);
    const imageUrl = urlData.publicUrl;
    console.log('Step 1 completed: Image uploaded to', imageUrl);

    // 2. ?몄뀡 ?앹꽦
    console.log('Step 2: Create session...');
    const { data: sessionData, error: sessionError } = await supabase
      .from('sessions')
      .insert({
        user_id: userId,
        image_url: imageUrl,
        status: 'processing'
      })
      .select('id')
      .single();

    if (sessionError) throw sessionError;
    createdSessionId = sessionData.id;
    console.log('Step 2 completed: Session created with ID', createdSessionId);

    // ?몄뀡 ?앹꽦 ??利됱떆 sessionId 諛섑솚 (遺꾩꽍? 諛깃렇?쇱슫?쒖뿉??怨꾩냽)
    const response = jsonResponse({
      success: true,
      sessionId: createdSessionId,
      message: 'Session created, analysis in progress',
    });

    // 諛깃렇?쇱슫???묒뾽 ?쒖옉
    EdgeRuntime.waitUntil(
      analyzeImageInBackground(
        createdSessionId,
        imageBase64,
        mimeType,
        userLanguage,
        geminiApiKey
      )
    );

    // ?몄뀡 ?앹꽦 ??利됱떆 ?묐떟 諛섑솚
    return response;
  } catch (error: any) {
    console.error('Error in analyze-image function:', error);
    
    // ?먮윭 諛쒖깮 ???몄뀡 ?곹깭瑜?failed濡??낅뜲?댄듃 (?몄뀡???앹꽦??寃쎌슦?먮쭔)
    if (supabase && typeof createdSessionId !== 'undefined') {
      try {
        console.log('Updating session status to failed...');
        await supabase
          .from('sessions')
          .update({ status: 'failed' })
          .eq('id', createdSessionId);
        console.log('Session status updated to failed');
      } catch (statusError) {
        console.error('Failed to update session status to failed:', statusError);
      }
    }
    
    return errorResponse(error.message || 'Internal server error', 500, error.toString());
  }
});}
