# 앱 수정 명세서 (Cursor AI 작업용)

---

## 📋 사전 작업: 프로젝트 분석 (필수)

구현 전에 다음을 먼저 분석해줘:

### 1. 프로젝트 구조 파악
- AI 분석 로직이 있는 파일 찾기
- DB 관련 함수들이 있는 파일 찾기
- 라우팅 설정 위치 확인
- 컴포넌트 폴더 구조 확인

### 2. DB 스키마 확인
- sessions 테이블의 현재 컬럼 구조
- status 또는 분석 상태를 나타낼 수 있는 컬럼 존재 여부
- 필요시 추가할 컬럼명 제안

### 3. 기존 코드 패턴 파악
- DB 클라이언트 사용 방법
- 현재 사용자 인증 처리 방식
- 기존 페이지 라우팅 패턴
- 에러 핸들링 방식

### 4. 충돌 가능성 체크
- 구현할 컴포넌트/페이지가 이미 존재하는지 확인
- 사용할 변수명이 기존 코드와 충돌하는지 확인

**분석 완료 후, 아래 명세서를 우리 프로젝트에 맞게 구체화하고 구현 계획을 작성해줘.**

---

## 1️⃣ 문제 분석 프로세스 개선

### 목표
업로드 후 즉시 분석중 페이지로 이동하고, 분석 완료 시 자동으로 결과 페이지로 이동

### A. 업로드 플로우 변경
**제거할 것:**
- 업로드 후 5초 대기 로직
- "이미지가 업로드 되었습니다" 같은 임시 메시지

**추가할 것:**
- 업로드 성공 시 즉시 "분석중" 페이지로 리다이렉트

### B. 분석중 페이지 신규 생성
**페이지 기능:**
- 애니메이션 텍스트: "분석중." → "분석중.." → "분석중..." (0.5초 간격, 무한 반복)
- 안내 문구: "웹에서 나가셔도 분석이 자동으로 수행됩니다"
- 주기적으로 분석 상태 확인 (2초 간격 권장)
- 분석 완료되면 자동으로 해당 세션의 상세 결과 페이지로 이동

**백엔드 요구사항:**
- 세션의 분석 상태를 저장할 수 있어야 함 (예: pending, processing, completed, failed)
- AI 분석 시작 시 상태를 'processing'으로 변경
- 분석 완료 시 상태를 'completed'로 변경
- 분석 실패 시 상태를 'failed'로 변경
- 프론트엔드에서 현재 상태를 조회할 수 있는 함수 필요

### C. 최근 업로드 섹션 개선
**현재 문제:**
- 모든 업로드 이미지가 표시됨

**개선 방향:**
- 최신순으로 정렬
- 기본적으로 최근 5개만 표시
- "전체 보기" 버튼 추가 → 클릭 시 전체 목록 확장 (같은 페이지 내에서)

### D. 세션 상세 페이지 신규 생성
**페이지 목적:**
- 특정 세션의 업로드 이미지와 AI 분석 결과를 함께 보여줌

**레이아웃:**
- 화면을 좌우 50:50으로 분할
- 좌측: 업로드된 원본 이미지 표시
- 우측: AI 분석 결과 + 수정 가능한 폼
- 이미지 클릭 시 확대보기 모달

**보안:**
- 본인의 세션만 접근 가능하도록 검증

---

## 2️⃣ 통계 화면 개선

### 목표
모든 카테고리 depth별로 정오답 통계를 집계하고, 계층 구조로 표시

### A. 뎁스별 통계 집계
**현재 문제:**
- 최종 depth의 정오답만 집계됨

**개선 방향:**
- 모든 depth 레벨(1-depth, 2-depth, 3-depth, 4-depth)별로 정오답 개수 집계
- 성능 최적화: 한 번의 순회로 모든 depth 통계를 동시에 계산 (중복 순회 금지)
- 각 depth 조합을 키로 하는 맵/딕셔너리 구조 사용 권장

**집계 로직 예시 개념:**
```
각 문제마다:
  - depth1 카테고리에 집계
  - depth1 > depth2 조합에 집계
  - depth1 > depth2 > depth3 조합에 집계
  - depth1 > depth2 > depth3 > depth4 조합에 집계
```

### B. 계층 구조 테이블 구현
**UI 요구사항:**
- 초기 화면: 1-depth 대분류만 표시 (예: 어휘, 문법, 독해)
- 각 행에 정답/오답/합계 개수 표시
- 펼침/접기 아이콘 (▶/▼)

**인터랙션:**
1. 카테고리 행 클릭 → 하위 depth 펼침/접기 (아코디언 방식)
2. 정오답 개수 클릭 → 해당 카테고리의 문제 이미지들을 모달로 표시
3. 모달 내 이미지 클릭 → 세션 상세 페이지로 이동

**구현 제안:**
- 재귀적 컴포넌트 구조 사용 가능
- 들여쓰기로 depth 레벨 시각화

---

## 3️⃣ 이미지 기능 추가

### 목표
이미지 확대, 다운로드, 회전 기능 제공

### A. 이미지 회전 기능 (업로드 직후, AI 분석 전)
**위치:**
- 이미지 업로드 컴포넌트 내 (AI 분석 시작 전 단계)

**기능:**
- 좌회전/우회전 버튼 (각 90도씩)
- 즉시 화면에 반영 (CSS transform 사용 가능)
- 회전된 이미지를 실제 파일로 변환하여 서버에 업로드
- Canvas API를 사용해 회전된 이미지 생성 권장

**사용자 플로우:**
1. 사용자가 이미지 선택
2. 미리보기 화면에서 회전 버튼으로 방향 조정
3. "업로드" 또는 "분석 시작" 버튼 클릭
4. 회전된 이미지가 서버로 전송되어 AI 분석 시작

### B. 이미지 확대보기 모달 (AI 분석 후, 통계 화면)
**위치:**
- 통계 페이지의 세션 목록 또는 문제 이미지 썸네일

**트리거:**
- 이미지 썸네일 클릭 시

**모달 스펙:**
- 반투명 검정 배경
- 중앙에 원본 크기 이미지
- 외부 클릭 또는 X 버튼으로 닫기
- 다운로드 버튼 포함

### C. 다운로드 기능 (AI 분석 후, 통계 화면)
**위치:**
- 확대보기 모달 내

**기능:**
- 원본 이미지 다운로드
- 파일명은 세션 ID 기반으로 생성 (원본 확장자 유지)

**사용 시점:**
- AI 분석이 완료된 후
- 통계 페이지에서 이미지를 확인할 때

---

## 4️⃣ 로딩 속도 개선

### 목표
불필요한 섹션 제거로 초기 로딩 속도 향상

### 제거 대상
- 통계 페이지의 '개인화 코칭' 섹션
- 관련 컴포넌트, API 호출, import 모두 제거
- 레이아웃 자연스럽게 조정 (빈 공간 없이)

---

## ✅ 구현 가이드

### 권장 작업 순서

**Phase 1: 백엔드 기반 작업**
1. 분석 상태 관리 시스템 구축
   - DB에 상태 컬럼 추가 (필요시)
   - 상태 업데이트 함수 구현
   - 상태 조회 함수 구현
   - AI 분석 로직에 상태 변경 코드 추가

**Phase 2: 핵심 프론트엔드**
2. 분석중 페이지 생성 및 상태 폴링
3. 세션 상세 페이지 생성
4. 업로드 플로우 수정 (5초 대기 제거)
5. 계층 구조 통계 테이블 구현
6. 통계 집계 로직 최적화

**Phase 3: UX 개선**
7. 이미지 모달 (확대/다운로드/회전)
8. 최근 업로드 5개 제한 + 전체 보기
9. 개인화 코칭 제거

### 보안 체크포인트
- 모든 DB 조회 시 현재 사용자 검증
- 세션 접근 권한 확인
- 기존 보안 정책(RLS 등) 준수

### 주의사항
- Phase 1 완료 후 Phase 2 진행 (분석 상태 관리 없으면 폴링 무의미)
- 통계 집계는 성능 최적화 필수 (단일 순회)
- 기존 코드 스타일/패턴 유지
- 변수명/함수명 충돌 방지

---

## 📝 구현 전 확인사항

위 명세서를 구현하기 전에:
1. 프로젝트 구조 분석 결과 공유
2. 잠재적 문제점 또는 대안 제시
3. 단계별 상세 구현 계획 작성
4. 각 단계별 예상 소요 시간 및 테스트 방법 제안

**모든 준비가 완료되면 Phase 1부터 순차적으로 구현 시작**